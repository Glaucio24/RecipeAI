@page "/mealRecipe/{Index:int}"
@using RecipeAI
@inject NavigationManager Navigation
@inject RecipeState recipeState
@using RecipeAI.Services
@inject IOpenAIAPI openAIService
@rendermode InteractiveServer

<div class="container mt-5 h-100">
    @if (isLoading)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="d-flex flex-column flex-lg-row justify-content-start">
            <div class="text-center text-lg-start">
                @if (recipeImage?.Data != null && recipeImage.Data.Length > 0)
                {
                    <img class="rounded-3" src="@recipeImage.Data[0].Url" alt="Recipe Image" />
                }
                else
                {
                    <p>No image available</p>
                }
            </div>
            <div class="flex-grow-1 px-3">
                <h1 class="fw-bold">@Title</h1>
                <p>@Description</p>
            </div>
        </div>
        <div class="row row-cols-1 row-cols-md-2 mt-3">
            <div class="col">
                <h2>Ingredients</h2>
                <ul>
                    @foreach (var ingredient in Ingredients)
                    {
                        <li>@ingredient</li>
                    }
                </ul>
            </div>
            <div class="col">
                <h2>Instructions</h2>
                <p>@Instructions</p>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Index { get; set; }

    private bool isLoading = true;
    private string? Title;
    private string? Description;
    private List<string> Ingredients = new List<string>();  // List for ingredients
    private string? Instructions;
    private RecipeImage? recipeImage;

    protected override async Task OnInitializedAsync()
    {
        if (recipeState?.Ideas != null && Index >= 0 && Index < recipeState.Ideas.Count)
        {
            var recipeIdea = recipeState.Ideas[Index];
            Title = recipeIdea.Title;
            Description = recipeIdea.Description;

            // Fetch recipe details asynchronously
            var recipeTask = openAIService.CreateRecipe(recipeIdea.Title, recipeState.IngredientList);
            var imageTask = openAIService.CreateRecipeImage(recipeIdea.Title);

            // Wait for both tasks to complete
            var recipe = await recipeTask;
            recipeImage = await imageTask;

            if (recipe != null)
            {
                // Convert ingredients array to List<string> if it's an array
                Ingredients = recipe.Ingredients?.ToList() ?? new List<string>();

                // Handle instructions (ensure it's a string)
                if (recipe.Instructions != null)
                {
                    // If Instructions is an array, join it into a single string
                    Instructions = string.Join(" ", recipe.Instructions) ?? "No instructions available.";
                }
                else
                {
                    Instructions = "No instructions available.";
                }
            }
        }
        else
        {
            Title = "Recipe not found";
        }

        isLoading = false; // Set loading to false after everything is loaded
    }
}
